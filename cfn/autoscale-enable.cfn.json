{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Metadata":{
      "AWS::CloudFormation::Interface":{
         "ParameterGroups":[
            {
               "Label":{
                  "default":"Function Code Location"
               },
               "Parameters":[
                  "FunctionS3Bucket",
                  "FunctionS3Key"
               ]
            },
            {
               "Label":{
                  "default":"DynamoDB Autoscale Configuration"
               },
               "Parameters":[
                  "AutoScalingRoleName",
                  "MinThroughput",
                  "MaxThroughput"
               ]
            }
         ]
      }
   },
   "Parameters":{
      "FunctionS3Bucket":{
         "Type":"String",
         "Default":"",
         "Description":"S3 bucket containing the Lambda function zip file"
      },
      "FunctionS3Key":{
         "Type":"String",
         "Default":"",
         "Description":"S3 key within the bucket for the function (ie. folder/foo.zip)"
      },
      "AutoScalingRoleName":{
         "Type":"String",
         "Default":"DynamoDBAutoscaleRole",
         "Description":"IAM Role which can perform DynamoDB autoscaling operations"
      },
      "MinThroughput":{
         "Type":"String",
         "Default":"5",
         "Description":"Minimum provisioned throughput to scale down to"
      },
      "MaxThroughput":{
         "Type":"String",
         "Default":"40000",
         "Description":"Maximum provisioned throughput to scale up to"
      }
   },
   "Resources":{
      "FunctionRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "Path":"/dynamodb/autoscale/",
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "lambda.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Policies":[
               {
                  "PolicyName":"DynamoDBAutoscalingEnable",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Sid":"Logging",
                           "Action":[
                              "logs:CreateLogGroup",
                              "logs:CreateLogStream",
                              "logs:PutLogEvents"
                           ],
                           "Effect":"Allow",
                           "Resource":"arn:aws:logs:*:*:*:*"
                        },
                        {
                           "Sid":"IAMAccess",
                           "Action":[
                              "iam:GetRole",
                              "iam:PassRole"
                           ],
                           "Effect":"Allow",
                           "Resource":"*"
                        },
                        {
                          "Sid":"AppAutoScaling",
                          "Action":[
                            "application-autoscaling:*"
                          ],
                          "Effect":"Allow",
                          "Resource": "*"

                        },
                        {
                           "Sid":"ManipulateTables",
                           "Action":[
                              "dynamodb:DescribeTable",
                              "dynamodb:ListTables",
                              "dynamodb:UpdateTable"
                           ],
                           "Effect":"Allow",
                           "Resource":"*"
                        }
                     ]
                  }
               }
            ]
         }
      },
      "AutoscaleEnableFunction":{
         "Type":"AWS::Lambda::Function",
         "Properties":{
            "FunctionName":"EnableDynamoDBAutoScaling",
            "Description":"Auto-enable autoscaling for newly created tables",
            "Role":{
               "Fn::GetAtt":[
                  "FunctionRole",
                  "Arn"
               ]
            },
            "Runtime":"python2.7",
            "Handler":"enable-as.lambda_handler",
            "MemorySize":128,
            "Timeout":20,
            "Environment":{
               "Variables":{
                  "rolename":{
                     "Ref":"AutoScalingRoleName"
                  },
                  "min_tput":{
                     "Ref":"MinThroughput"
                  },
                  "max_tput":{
                     "Ref":"MaxThroughput"
                  }
               }
            },
            "Code":{
               "S3Bucket":{
                  "Ref":"FunctionS3Bucket"
               },
               "S3Key":{
                  "Ref":"FunctionS3Key"
               }
            }
         }
      },
      "CreateTableRule":{
         "Type":"AWS::Events::Rule",
         "Properties":{
            "Description":"Invoke the autoscale enable lambda function when a new table is created",
            "Name":"EnableDynamoDBAutoscale",
            "State":"ENABLED",
            "EventPattern":{
               "source":[
                  "aws.dynamodb"
               ],
               "detail":{
                  "eventSource":[
                     "dynamodb.amazonaws.com"
                  ],
                  "eventName":[
                     "CreateTable"
                  ]
               }
            },
            "Targets":[
               {
                  "Arn":{
                     "Fn::GetAtt":[
                        "AutoscaleEnableFunction",
                        "Arn"
                     ]
                  },
                  "Id":"EnableDynamoDBAutoscale"
               }
            ]
         }
      },
      "CreateTablePermission":{
         "Type":"AWS::Lambda::Permission",
         "Properties":{
            "Action":"lambda:InvokeFunction",
            "FunctionName":{
               "Fn::GetAtt":[
                  "AutoscaleEnableFunction",
                  "Arn"
               ]
            },
            "Principal":"events.amazonaws.com",
            "SourceArn":{
               "Fn::GetAtt":[
                  "CreateTableRule",
                  "Arn"
               ]
            }
         }
      }
   }
}
